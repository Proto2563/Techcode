<!DOCTYPE html>
<html>
<head>
  <title>Make A Donation</title>
</head>
<body>

<form id="MakeDonation" enctype="multipart/form-data">
  <input type="text" id="IName" name="IName" placeholder="Enter Name of Item" required><br>
  
  <label for="ICategory">Choose the Category:</label>
    <select name="ICategory" id="ICategory">
      <option value="clothing">Clothing</option>
      <option value="food">Food</option>
      <option value="books">Books & Stationery</option>
      <option value="toys">Toys & Games</option>
      <option value="medical">Medical Supplies</option>
      <option value="household">Household Items</option>
      <option value="electronics">Electronics</option>
      <option value="furniture">Furniture</option>
      <option value="hygiene">Hygiene Products</option>
      <option value="mobility">Mobility Aids</option>
    </select><br>

  <label for="IDropLoc">Choose the Drop Location:</label>
    <select name="IDropLoc" id="IDropLoc">
      <option value="Charity Center, Shivajinagar, Pune">Charity Center, Shivajinagar, Pune</option>
      <option value="Relief Hub, Kothrud, Pune">Relief Hub, Kothrud, Pune</option>
      <option value="NGO Warehouse, Viman Nagar, Pune">NGO Warehouse, Viman Nagar, Pune</option>
      <option value="Collection Point, FC Road, Pune">Collection Point, FC Road, Pune</option>
      <option value="Mobile Van, Camp Area">Mobile Van, Camp Area</option>
    </select><br>

    <label for="IPhoto">Select Image of item:</label>
    <input type="file" name="IPhoto" id="IPhoto" required>
    <br>

  <button type="submit" id="b">Submit</button>
</form>

<div id="output" style="white-space: pre-wrap; margin-top: 10px;"></div>

<!--Call DID once at top so scope is in all script tags-->
<script>
  window.onload = function () {//make sure this code runs only after the page is fully loaded

    
  const urlParams = new URLSearchParams(window.location.search);
  const DID = urlParams.get('DID');

  //Check if DID recieved
  if (DID) {
    console.log("DID from URL:", DID);
  } else {
    alert("Donor ID not found in URL!");
  }

//Check if u can actually connect to the server before checking credentials
fetch('http://localhost:3000')
  .then(response => response.json())
  .then(data => {
    console.log(data);
    document.getElementById("output").innerText = JSON.stringify(data, null, 2);
  })
  .catch(error => {
    console.error("Error connecting to Node.js backend:", error);
  });

//Wen submit button is pressed
document.getElementById("MakeDonation").addEventListener("submit", async function (e) {
  e.preventDefault();  // Stop form from submitting the normal way

  const IName = document.getElementById("IName").value;
  const ICategory = document.getElementById("ICategory").value;
  const IDropLoc = document.getElementById("IDropLoc").value;

  //Upload image separately
const fileInput = document.getElementById("IPhoto");
const file = fileInput.files[0];


  const randomString = Math.random().toString(36).substring(2, 8);  // simple random string
  const ext = file.name.substring(file.name.lastIndexOf('.'));      // make sure this line is placed before too
  const IPhoto = `${DID}_${Date.now()}_${randomString}${ext}`;


  
const formData = new FormData(); //Creates a new FormData object — which is used to send form fields and files together to the server
formData.append("Photograph", file);  // key: 'IPhoto' This adds the file to the form data with the key "photo".
formData.append("fileName", IPhoto); // ✅ This line tells backend to save with your custom name


// send to photo upload API
await fetch(`http://localhost:3000/uploadPhoto?fileName=${IPhoto}`, {
  method: "POST",
  body: formData  // sends file to server
});


  //upload data to db
  
  

  fetch("http://localhost:3000/MakeDonation", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ IName, ICategory, IDropLoc, DID, IPhoto })
  })
  .then(response => response.json())
  .then(data => {
    console.log("Response from server:", data);
    if (data.success) {
      // ✅ Manual redirect with DID
      window.location.href = `DonorHome.html?DID=${DID}`;
    } else {
      alert("Failed to Submit Donation");
    }
  })
  .catch(err => {
    console.error("Fetch error:", err);
  });
});
  };
</script>
</body>
</html>
