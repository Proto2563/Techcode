<!DOCTYPE html>
<html>
<head>
  <title>Your Donations</title>
</head>
<body>

<h2>Your Past Donations</h2>
<table border="1" id="donationTable">
  <thead>
    <tr>
      <th>Item ID</th>
      <th>Donor ID</th>
      <th>Item Name</th>
      <th>Category</th>
      <th>Drop Location</th>
      <th>Image</th>
      <th>Status</th>
      <th>Approve</th>
      <th>Reject</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);
    const AID = urlParams.get('AID');

    if (!AID) {
      alert("Donor ID missing");
      return;
    }

    fetch(`http://localhost:3000/AdminDonationsStatus`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const tbody = document.querySelector("#donationTable tbody"); //Finds tbody part of table where results will be inserted
//console.log("Data from backend:", data.donations);
          data.donations.forEach(item => {
            //console.log(item);  // ADD THIS TOO
            const row = document.createElement("tr");

            row.innerHTML = `
              <td>${item.IID}</td>
              <td>${item.DID}</td>
              <td>${item.IName}</td>
              <td>${item.ICategory}</td>
              <td>${item.IDropLoc}</td>
              <td><img src="../Photo/${item.IPhoto}" width="100"/></td>
              <td>${item.IStatus}</td>
              <td>
                ${item.IStatus === "Approved" || item.IStatus === "Rejected"
                  ? ""
                  : `<button onclick="approveItem(${item.IID}, this)">Approve</button>`}
              </td>
              <td>
                ${item.IStatus === "Approved" || item.IStatus === "Rejected"
                  ? ""
                  : `<button onclick="rejectItem(${item.IID}, this)">Reject</button>`}
              </td>

            `;
            //<img src="../Photo/${item.IPhoto}" width="100"/>

            tbody.appendChild(row); //Adds row to end of tbody
          });
        } else {
          alert("Failed to fetch donations");
        }
      })

      .catch(err => {
        console.error("Fetch error:", err);
      });
  };

  // ✅ Define approveItem function here
  function approveItem(IID, btn) {
    fetch(`http://localhost:3000/AdminApproveDonation?IID=${IID}`, {
      method: "POST"
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Update the status cell
        const row = btn.parentElement.parentElement;
        row.children[6].innerText = "Approved";   // Update status cell
        row.children[7].innerHTML = "";           // Clear Approve button cell
        row.children[8].innerHTML = "";           // Clear Reject button cell

      } else {
        alert("Approval failed");
      }
    })
    .catch(err => {
      console.error("Approval request failed:", err);
    });
  }

  // ✅ Define rejectItem function here
  function rejectItem(IID, btn) {
    fetch(`http://localhost:3000/AdminRejectDonation?IID=${IID}`, {
      method: "POST"
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Update the Pending cell to Rejected
        const row = btn.parentElement.parentElement;
        row.children[6].innerText = "Rejected";   // Update status cell
        row.children[7].innerHTML = "";           // Clear Approve button cell
        row.children[8].innerHTML = "";           // Clear Reject button cell

      } else {
        alert("Rejection failed");
      }
    })
    .catch(err => {
      console.error("Rejection request failed:", err);
    });
  }
</script>

</body>
</html>

